services:
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: kafka-kraft
    ports:
      - "9092:9092"
      - "9094:9094"
    networks:
      - kafka-network
    volumes:
      - kafka-kraft-logs:/var/lib/kafka/data
      - ./config/kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,SASL_PLAINTEXT://0.0.0.0:9094,SASL_PLAINTEXT_INTERNAL://0.0.0.0:19094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,SASL_PLAINTEXT://localhost:9094,SASL_PLAINTEXT_INTERNAL://kafka:19094
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_PLAINTEXT_INTERNAL:SASL_PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    networks:
      - kafka-network
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:19094
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: SASL_PLAINTEXT
      KAFKA_CLUSTERS_0_PROPERTIES_SASL_MECHANISM: PLAIN
      KAFKA_CLUSTERS_0_PROPERTIES_SASL_JAAS_CONFIG: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="admin-secret";'
    depends_on:
      - kafka

volumes:
  kafka-kraft-logs:
    driver: local
    name: kafka-kraft-logs

networks:
  kafka-network:
    name: kafka-compose-network
    driver: bridge



############## KAFKA ROTATED SECRETS ###################
# Use below in kafka_server_jaas.conf

# KafkaServer {
#   org.apache.kafka.common.security.scram.ScramLoginModule required;
# };

# Update environment variables

# KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
# KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN

# Add new users

# docker exec -it kafka-kraft /bin/bash

# [appuser@090363d2b8e8 ~]$ cat > /tmp/client-scram.properties <<EOF
# > security.protocol=SASL_PLAINTEXT
# > sasl.mechanism=SCRAM-SHA-256
# > sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \
# > username="admin" \
# > password="admin-secret";
# > EOF

# USES 9092 port
# [appuser@090363d2b8e8 ~]$ /bin/kafka-configs --bootstrap-server localhost:9092 --alter --add-config 'SCRAM-SHA-256=[password=admin-secret]' --entity-type users --entity-name admin

# USES 9094 port
# [appuser@090363d2b8e8 ~]$ /bin/kafka-configs --bootstrap-server localhost:9094 --command-config /tmp/client-scram.properties --alter --add-config 'SCRAM-SHA-256=[password=admin-secret]' --entity-type users --entity-name admin

# Rotate Secrets
# [appuser@090363d2b8e8 ~]$ /bin/kafka-configs --bootstrap-server localhost:9092 --alter --add-config 'SCRAM-SHA-256=[password=rotated-secret]' --entity-type users --entity-name admin

# In application.properties
# kafka.security.protocol=SASL_PLAINTEXT
# kafka.sasl.mechanism=SCRAM-SHA-256
# kafka.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="admin" password="admin-secret";